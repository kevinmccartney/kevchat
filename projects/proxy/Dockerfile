FROM nginx:1.27.4

WORKDIR /etc/nginx

ARG KEVCHAT_ENV=${KEVCHAT_ENV}
ARG KEVCHAT_IDP_INTERNAL_HOST=${KEVCHAT_IDP_INTERNAL_HOST}
ARG KEVCHAT_API_INTERNAL_HOST=${KEVCHAT_API_INTERNAL_HOST}
ARG KEVCHAT_CLIENT_INTERNAL_HOST=${KEVCHAT_CLIENT_INTERNAL_HOST}
ARG KEVCHAT_FRONT_DOOR_INTERNAL_HOST=${KEVCHAT_FRONT_DOOR_INTERNAL_HOST}
ARG KEVCHAT_IDP_PORT=${KEVCHAT_IDP_PORT}
ARG KEVCHAT_API_PORT=${KEVCHAT_API_PORT}
ARG KEVCHAT_CLIENT_PORT=${KEVCHAT_CLIENT_PORT}
ARG KEVCHAT_FRONT_DOOR_PORT=${KEVCHAT_FRONT_DOOR_PORT}

ENV \
  KEVCHAT_ENV=${KEVCHAT_ENV} \
  KEVCHAT_IDP_INTERNAL_HOST=${KEVCHAT_IDP_INTERNAL_HOST} \
  KEVCHAT_API_INTERNAL_HOST=${KEVCHAT_API_INTERNAL_HOST} \
  KEVCHAT_CLIENT_INTERNAL_HOST=${KEVCHAT_CLIENT_INTERNAL_HOST} \
  KEVCHAT_FRONT_DOOR_INTERNAL_HOST=${KEVCHAT_FRONT_DOOR_INTERNAL_HOST} \
  KEVCHAT_IDP_PORT=${KEVCHAT_IDP_PORT} \
  KEVCHAT_API_PORT=${KEVCHAT_API_PORT} \
  KEVCHAT_CLIENT_PORT=${KEVCHAT_CLIENT_PORT} \
  KEVCHAT_FRONT_DOOR_PORT=${KEVCHAT_FRONT_DOOR_PORT}

COPY projects/proxy/default.conf conf.d/default.conf
COPY projects/proxy/nginx.conf nginx.conf
COPY projects/proxy/includes includes

RUN export VARS_TO_REPLACE='$KEVCHAT_ENV $KEVCHAT_IDP_INTERNAL_HOST $KEVCHAT_API_INTERNAL_HOST $KEVCHAT_CLIENT_INTERNAL_HOST $KEVCHAT_FRONT_DOOR_INTERNAL_HOST $KEVCHAT_IDP_PORT $KEVCHAT_API_PORT $KEVCHAT_CLIENT_PORT $KEVCHAT_FRONT_DOOR_PORT' && \
  cat conf.d/default.conf | envsubst "$VARS_TO_REPLACE" > conf.d/default.conf && \
  unset VARS_TO_REPLACE
RUN find includes -type f -name '*.conf' -exec sh -c 'for f; do echo "$f" && cat "$f" | envsubst "\${KEVCHAT_ENV}" > "$f"; done' _ {} +
FROM nginx:1.27.4

WORKDIR /etc/nginx

ARG KEVCHAT_API_INTERNAL_HOST
ARG KEVCHAT_API_PORT
ARG KEVCHAT_CLIENT_INTERNAL_HOST
ARG KEVCHAT_CLIENT_PORT
ARG KEVCHAT_CLIENT_URL
ARG KEVCHAT_ENV
ARG KEVCHAT_FRONT_DOOR_INTERNAL_HOST
ARG KEVCHAT_FRONT_DOOR_PORT
ARG KEVCHAT_IDP_INTERNAL_HOST
ARG KEVCHAT_IDP_PORT
ARG KEVCHAT_SOCKET_IO_ADMIN_URL
ARG KEVCHAT_KAFKA_UI_INTERNAL_HOST
ARG KEVCHAT_KAFKA_UI_PORT
ARG KEVCHAT_SOCKET_IO_ADMIN_INTERNAL_HOST
ARG KEVCHAT_SOCKET_IO_ADMIN_PORT

ENV \
  KEVCHAT_API_INTERNAL_HOST=${KEVCHAT_API_INTERNAL_HOST} \
  KEVCHAT_API_PORT=${KEVCHAT_API_PORT} \
  KEVCHAT_CLIENT_INTERNAL_HOST=${KEVCHAT_CLIENT_INTERNAL_HOST} \
  KEVCHAT_CLIENT_PORT=${KEVCHAT_CLIENT_PORT} \
  KEVCHAT_CLIENT_URL=${KEVCHAT_CLIENT_URL} \
  KEVCHAT_ENV=${KEVCHAT_ENV} \
  KEVCHAT_FRONT_DOOR_INTERNAL_HOST=${KEVCHAT_FRONT_DOOR_INTERNAL_HOST} \
  KEVCHAT_FRONT_DOOR_PORT=${KEVCHAT_FRONT_DOOR_PORT} \
  KEVCHAT_IDP_INTERNAL_HOST=${KEVCHAT_IDP_INTERNAL_HOST} \
  KEVCHAT_IDP_PORT=${KEVCHAT_IDP_PORT} \
  KEVCHAT_SOCKET_IO_ADMIN_URL=${KEVCHAT_SOCKET_IO_ADMIN_URL} \
  KEVCHAT_KAFKA_UI_INTERNAL_HOST=${KEVCHAT_KAFKA_UI_INTERNAL_HOST} \
  KEVCHAT_KAFKA_UI_PORT=${KEVCHAT_KAFKA_UI_PORT} \
  KEVCHAT_SOCKET_IO_ADMIN_INTERNAL_HOST=${KEVCHAT_SOCKET_IO_ADMIN_INTERNAL_HOST} \
  KEVCHAT_SOCKET_IO_ADMIN_PORT=${KEVCHAT_SOCKET_IO_ADMIN_PORT}

COPY projects/proxy/default.conf conf.d/default.conf
COPY projects/proxy/nginx.conf nginx.conf
COPY projects/proxy/includes includes

RUN export VARS_TO_REPLACE='$KEVCHAT_ENV $KEVCHAT_IDP_INTERNAL_HOST $KEVCHAT_API_INTERNAL_HOST $KEVCHAT_CLIENT_INTERNAL_HOST $KEVCHAT_FRONT_DOOR_INTERNAL_HOST $KEVCHAT_IDP_PORT $KEVCHAT_API_PORT $KEVCHAT_CLIENT_PORT $KEVCHAT_FRONT_DOOR_PORT $KEVCHAT_KAFKA_UI_INTERNAL_HOST $KEVCHAT_KAFKA_UI_PORT $KEVCHAT_SOCKET_IO_ADMIN_INTERNAL_HOST $KEVCHAT_SOCKET_IO_ADMIN_PORT' && \
  cat conf.d/default.conf | envsubst "$VARS_TO_REPLACE" > conf.d/default.conf && \
  unset VARS_TO_REPLACE
RUN cat nginx.conf | envsubst "\${KEVCHAT_CLIENT_URL} \${KEVCHAT_SOCKET_IO_ADMIN_URL}" > nginx.conf
RUN find includes -type f -name '*.conf' -exec sh -c 'for f; do echo "$f" && cat "$f" | envsubst "\${KEVCHAT_ENV}" > "$f"; done' _ {} +